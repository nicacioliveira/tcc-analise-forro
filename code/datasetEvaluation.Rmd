---
title: "Dataset evaluation"
output: html_notebook
---

```{r}
library(dplyr)
library(RMySQL)
library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
library(gridExtra)
library(tidytext)
library(wordcloud)
library(wordcloud2)
library(reshape)
library(ggdendro)
library(tm)
library(lexiconPT)

colors <- c("#E69F00", "#56B4E9", "#009E73", "#CC79A7", "#D55E00")
```

```{r}
db <- dbConnect(RMySQL::MySQL(), user = 'root', password = 'root', dbname = 'tcc', host = '127.0.0.1', port = 3306)
query_str <- "SELECT m.name as music_name, a.name as artist_name, m.year, m.lyric as lyric FROM music as m INNER JOIN artists as a ON m.artist_id = a.id WHERE m.year is not null"
query <- dbSendQuery(db, query_str)
dataset <- fetch(query, n = 40000)

# convertendo anos ch para num
dataset$year <- dataset$year %>% as.character %>% as.numeric

dataset$year <- as.numeric(as.numeric(dataset$year))

dbDisconnect(db)
```
# Avaliação do dataset
```{r}
summary(dataset)
```


# Classificando as décadas das músicas
```{r}
dataset <- dataset %>%
  mutate(decade =
           ifelse(dataset$year %in% 1950:1959, "1950s", 
           ifelse(dataset$year %in% 1960:1969, "1960s", 
           ifelse(dataset$year %in% 1970:1979, "1970s", 
           ifelse(dataset$year %in% 1980:1989, "1980s", 
           ifelse(dataset$year %in% 1990:1999, "1990s", 
           ifelse(dataset$year %in% 2000:2009, "2000s", 
           ifelse(dataset$year %in% 2010:2019, "2010s", 
                  "NA"))))))))
```

```{r}
theme_lyrics <- function() 
{
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")
}
```


# Exibindo a quantidade de músicas por década
```{r}
dataset %>%
  filter(decade != "NA") %>%
  group_by(decade) %>%
  summarise(number_of_songs = n()) %>%
  ggplot() + 
  geom_bar(aes(x = decade, y = number_of_songs), stat = "identity")  +
  theme(plot.title = element_text(hjust = 0.5), legend.title = element_blank(), panel.grid.minor = element_blank()) +
  ggtitle("Quantidade de músicas por década") +
  labs(x = NULL, y = "Músicas")
```

````{r}
head(stopwords('pt'), 15)
```

# *Análise das letras*


```{r}
stopwords_pt <- data.frame(word = tm::stopwords("portuguese"))
undesirable_words <- c("refrão", "refrao", "repete", "2x")
```

```{r}
filterDataSetByDecade <- function(d) {
  ds_filtered <- dataset %>%filter(decade == d)
  
  result <- ds_filtered %>%
  unnest_tokens(word, lyric) %>%
  anti_join(stopwords_pt) %>%
  distinct() %>%
  filter(!word %in% undesirable_words) %>%
  filter(nchar(word) > 3)
  return(result)
}

dataset_filtered <-dataset %>%
  unnest_tokens(word, lyric) %>%
  anti_join(stopwords_pt) %>%
  distinct() %>%
  filter(!word %in% undesirable_words) %>%
  filter(nchar(word) > 3)

```

#Quantidade de palavras mais usadas por década
````{r}
wordsCounterPerDecade <- function(d) {
  ds <- dataset_filtered %>% filter(decade == d)
  
  ds %>%
  count(word, sort = TRUE) %>%
  top_n(10) %>%
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot() +
    geom_col(aes(word, n), fill = colors[4]) +
    theme(legend.position = "none", 
          plot.title = element_text(hjust = 0.5),
          panel.grid.major = element_blank()) +
    xlab("") + 
    ylab("Quantidade de músicas") +
    ggtitle("Palavras") +
    coord_flip()

}

wordsCounterPerDecade("1950s")
wordsCounterPerDecade("1960s")
wordsCounterPerDecade("1970s")
wordsCounterPerDecade("1980s")
wordsCounterPerDecade("1990s")
wordsCounterPerDecade("2000s")
wordsCounterPerDecade("2010s")
wordsCounterPerDecade("")
```

```{r}
words_quantity <- dataset_filtered %>%
  count(word, sort = TRUE)

wordsQuantityCounter<- function(ds_filtered) {
  result <- ds_filtered %>% count(word, sort = TRUE)
  return(result)
}
```

```{r}

letterCloud(words_quantity, size = 2, word = "FORRÓ")
wordcloud2((filterDataSetByDecade("1950s") %>%  wordsQuantityCounter)[1:200, ], size = .5)
wordcloud2((filterDataSetByDecade("1960s") %>%  wordsQuantityCounter)[1:200, ], size = .5)
wordcloud2((filterDataSetByDecade("1970s") %>%  wordsQuantityCounter)[1:300, ], size = .5)
wordcloud2((filterDataSetByDecade("1980s") %>%  wordsQuantityCounter)[1:300, ], size = .5)
wordcloud2((filterDataSetByDecade("1990s") %>%  wordsQuantityCounter)[1:300, ], size = .5)
wordcloud2((filterDataSetByDecade("2000s") %>%  wordsQuantityCounter)[1:300, ], size = .5)
wordcloud2((filterDataSetByDecade("2010s") %>%  wordsQuantityCounter)[1:300, ], size = .5)
```

#palavras atemporais (que permanecem desde a primeira década até a última)
Palavras que mais duram ficam no topo do gráfico
```{r}
timeless_words <- dataset_filtered %>% 
  filter(decade != 'NA') %>%
  group_by(decade) %>%
  count(word, decade, sort = TRUE) %>%
  slice(seq_len(8)) %>%
  ungroup() %>%
  arrange(decade,n) %>%
  mutate(row = row_number()) 

timeless_words %>%
  ggplot(aes(row, n, fill = decade)) +
    geom_col(show.legend = NULL) +
    labs(x = NULL, y = "Palavras") +
    ggtitle("Palavras Atemporaris") + 
    theme_lyrics() +  
    facet_wrap(~decade, scales = "free", ncol = 5) +
    scale_x_continuous(breaks = timeless_words$row, labels = timeless_words$word) +
    coord_flip()
```

#Palavras mais longas
Palavras maiores podem acrescentar complexidade nas letras e também podem indicar, ao longo do tempo, se as letras ficaram mais ou menos complexas a partir desse ponto

Pode indicar, então, simplicidade ou não?
```{r}

countWordLenghtsPerDecade <- function(d) {
  ds <- dataset %>% filter(decade == d)
  result <- ds %>%
  unnest_tokens(word, lyric) %>%
  group_by(music_name, decade) %>%
  distinct() %>%
  filter(!word %in% undesirable_words) %>%
  mutate(word_length = nchar(word))
  return(result)
}

plotWordLenghts <- function(word_lengths, decade) {
  word_lengths %>%
  count(word_length, sort = TRUE) %>%
  ggplot(aes(word_length), binwidth = 10) + 
  geom_histogram(aes(fill = ..count..), breaks = seq(1,25, by = 2),
  show.legend = FALSE) + 
  xlab("Tamanho das palavras") + ylab("Quantidade das palavras") +
  ggtitle(paste("Distribuição da quantidade de palavras por seus tamanhos nos anos de ")) +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.minor = element_blank())
}

all_word_lengths <- dataset %>%
  unnest_tokens(word, lyric) %>%
  group_by(music_name, decade) %>%
  distinct() %>%
  filter(!word %in% undesirable_words) %>%
  mutate(word_length = nchar(word)) 

all_word_lengths %>%
  count(word_length, sort = TRUE) %>%
  ggplot(aes(word_length), binwidth = 10) + 
  geom_histogram(aes(fill = ..count..), breaks = seq(1,25, by = 2),
  show.legend = FALSE) + 
  xlab("Tamanho das palavras") + ylab("Quantidade das palavras") +
  ggtitle("Distribuição da quantidade de palavras por seus tamanhos") +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.minor = element_blank())
```
E por década?
````{r}
plotWordLenghts(countWordLenghtsPerDecade("2000s"), "2000s")

```

```{r}
wc <- all_word_lengths %>%
  ungroup() %>%
  select(word, word_length) %>%
  distinct() %>%
  arrange(desc(word_length))

wordcloud2(wc[1:300, ], 
           size = .15,
           minSize = .0005,
           ellipticity = .3, 
           rotateRatio = 1, 
           fontWeight = "bold")
```

#Diversidade lexical

